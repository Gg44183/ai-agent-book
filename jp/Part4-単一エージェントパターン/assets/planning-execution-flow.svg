<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 680 520">
  <defs>
    <style>
      .label { font: 500 10px 'SF Mono', 'Menlo', 'Monaco', monospace; fill: #666; text-anchor: middle; letter-spacing: 0.5px; }
      .box-text { font: 600 12px 'SF Mono', 'Menlo', 'Monaco', monospace; fill: #1a1a1a; text-anchor: middle; }
      .title { font: 700 14px 'SF Mono', 'Menlo', 'Monaco', monospace; fill: #1a1a1a; text-anchor: middle; letter-spacing: 1px; }
      .annotation { font: 400 9px 'SF Mono', 'Menlo', 'Monaco', monospace; fill: #666; }
      .phase-label { font: 700 11px 'SF Mono', 'Menlo', 'Monaco', monospace; fill: #fff; text-anchor: middle; }
      .percent { font: 700 14px 'SF Mono', 'Menlo', 'Monaco', monospace; text-anchor: middle; }
      .decision { font: 500 10px 'SF Mono', 'Menlo', 'Monaco', monospace; fill: #1a1a1a; text-anchor: middle; }
    </style>
    <marker id="arrow-main" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#4f46e5"/>
    </marker>
    <marker id="arrow-loop" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f59e0b"/>
    </marker>
    <marker id="arrow-exit" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#10b981"/>
    </marker>
    <!-- Circular gradient for center loop -->
    <radialGradient id="loop-center" cx="50%" cy="50%" r="50%">
      <stop offset="0%" style="stop-color:#fef3c7"/>
      <stop offset="100%" style="stop-color:#fde047"/>
    </radialGradient>
  </defs>

  <!-- Background -->
  <rect width="680" height="520" fill="#fff"/>

  <!-- Title -->
  <text x="340" y="28" class="title">PLANNING EXECUTION FLOW</text>
  <text x="340" y="45" class="label">Planning パターン実行フロー</text>

  <!-- Phase 1: Initial Decomposition -->
  <g transform="translate(100, 80)">
    <circle cx="0" cy="0" r="22" fill="#4f46e5"/>
    <text x="0" y="6" class="phase-label">1</text>

    <rect x="30" y="-25" width="180" height="50" fill="#dbeafe" stroke="#1a1a1a" stroke-width="1.5" rx="4"/>
    <text x="120" y="-5" class="box-text">タスク分解</text>
    <text x="120" y="12" class="label">DECOMPOSITION</text>
  </g>

  <!-- Arrow to Phase 2 -->
  <line x1="310" y1="80" x2="360" y2="80" stroke="#4f46e5" stroke-width="2" marker-end="url(#arrow-main)"/>

  <!-- Phase 2: Execute Subtasks -->
  <g transform="translate(420, 80)">
    <circle cx="0" cy="0" r="22" fill="#4f46e5"/>
    <text x="0" y="6" class="phase-label">2</text>

    <rect x="30" y="-25" width="180" height="50" fill="#a5f3fc" stroke="#1a1a1a" stroke-width="1.5" rx="4"/>
    <text x="120" y="-5" class="box-text">サブタスク実行</text>
    <text x="120" y="12" class="label">EXECUTE SUBTASKS</text>
  </g>

  <!-- Arrow down to loop -->
  <line x1="540" y1="105" x2="540" y2="150" stroke="#4f46e5" stroke-width="2" marker-end="url(#arrow-main)"/>

  <!-- Central Iteration Loop (the creative part) -->
  <g transform="translate(340, 300)">
    <!-- Outer ring -->
    <circle cx="0" cy="0" r="120" fill="none" stroke="#fde047" stroke-width="3" stroke-dasharray="8,4"/>

    <!-- Inner evaluation box -->
    <rect x="-80" y="-45" width="160" height="90" fill="url(#loop-center)" stroke="#f59e0b" stroke-width="2" rx="8"/>
    <text x="0" y="-15" class="box-text">カバレッジ評価</text>
    <text x="0" y="5" class="label">COVERAGE EVAL</text>

    <!-- Progress indicator inside -->
    <rect x="-60" y="18" width="120" height="16" fill="#fff" stroke="#f59e0b" stroke-width="1" rx="4"/>
    <rect x="-58" y="20" width="90" height="12" fill="#f59e0b" rx="3"/>
    <text x="0" y="45" class="percent" fill="#92400e">75%</text>

    <!-- Decision diamond on right -->
    <g transform="translate(140, 0)">
      <polygon points="0,-35 45,0 0,35 -45,0" fill="#fef3c7" stroke="#1a1a1a" stroke-width="1.5"/>
      <text x="0" y="-5" class="decision">≥ 85%?</text>
      <text x="0" y="10" class="annotation">カバレッジ</text>
    </g>

    <!-- Loop back arrow (NO path) -->
    <path d="M 95 35 Q 120 80 80 120 Q 0 160 -80 120 Q -120 80 -120 0 Q -120 -80 -80 -120 Q 0 -170 150 -120"
          fill="none" stroke="#f59e0b" stroke-width="2" stroke-dasharray="6,3"/>
    <text x="-130" y="0" class="annotation" style="fill: #f59e0b; font-weight: 600;">NO</text>
    <text x="-130" y="15" class="annotation" style="fill: #f59e0b;">反復継続</text>

    <!-- Subquery generation box (on the loop) -->
    <g transform="translate(-180, -80)">
      <rect x="-60" y="-20" width="120" height="40" fill="#fce7f3" stroke="#db2777" stroke-width="1.5" rx="4"/>
      <text x="0" y="-2" class="box-text" style="font-size: 10px;">補足クエリ生成</text>
      <text x="0" y="12" class="label">SUBQUERIES</text>
    </g>
  </g>

  <!-- YES exit path -->
  <g transform="translate(525, 300)">
    <line x1="0" y1="0" x2="80" y2="0" stroke="#10b981" stroke-width="3" marker-end="url(#arrow-exit)"/>
    <text x="40" y="-10" class="annotation" style="fill: #10b981; font-weight: 600;">YES</text>

    <!-- Phase 3: Synthesis -->
    <g transform="translate(110, 0)">
      <circle cx="0" cy="0" r="22" fill="#10b981"/>
      <text x="0" y="6" class="phase-label">3</text>
    </g>

    <rect x="85" y="40" width="100" height="45" fill="#d1fae5" stroke="#1a1a1a" stroke-width="1.5" rx="4"/>
    <text x="135" y="60" class="box-text">統合出力</text>
    <text x="135" y="75" class="label">SYNTHESIS</text>
  </g>

  <!-- Entry arrow from Phase 2 to loop -->
  <path d="M 540 150 Q 540 200 480 255" fill="none" stroke="#4f46e5" stroke-width="2" marker-end="url(#arrow-main)"/>

  <!-- Iteration counter on left -->
  <g transform="translate(60, 300)">
    <rect x="0" y="-50" width="90" height="100" fill="#f8fafc" stroke="#e2e8f0" stroke-width="1" rx="4"/>
    <text x="45" y="-30" class="annotation" style="font-weight: 600;">反復回数</text>
    <text x="45" y="-10" class="percent" style="fill: #4f46e5;">N / 3</text>
    <line x1="15" y1="5" x2="75" y2="5" stroke="#e2e8f0" stroke-width="1"/>
    <text x="45" y="25" class="annotation">MaxIterations</text>
    <text x="45" y="40" class="annotation" style="fill: #ef4444;">上限で強制停止</text>
  </g>

  <!-- Bottom legend -->
  <g transform="translate(120, 465)">
    <rect x="0" y="0" width="440" height="40" fill="#f8fafc" stroke="#e2e8f0" stroke-width="1" rx="4"/>
    <text x="220" y="15" class="annotation" style="font-weight: 600;">終了条件 (いずれか1つで発動)</text>

    <circle cx="40" cy="30" r="4" fill="#10b981"/>
    <text x="55" y="33" class="annotation">カバレッジ ≥ 85%</text>

    <circle cx="170" cy="30" r="4" fill="#f59e0b"/>
    <text x="185" y="33" class="annotation">重要ギャップなし</text>

    <circle cx="300" cy="30" r="4" fill="#ef4444"/>
    <text x="315" y="33" class="annotation">MaxIterationsに到達</text>
  </g>
</svg>
